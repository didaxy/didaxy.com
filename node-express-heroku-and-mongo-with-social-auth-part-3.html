<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.2.3" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="./favicon.png">
<link rel="stylesheet" href="static.css">
<title>Node, Express, Heroku and Mongo with Social Auth Part 3: Didaxy.com ‚Äî Computers and Learning, Tutorials, index, Configurator</title>
</head>
<body><p><nav class="header">
<ul class="header-nav header-nav-left">
<li class="header-item header-site-logo">
<a class="header-nav-link" href="./index.html">
<img src="data:image/svg+xml,%3Csvg%20width%3D%22400%22%20height%3D%22400%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Asvg%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%3C!--%20Created%20with%20SVG-edit%20-%20http%3A%2F%2Fsvg-edit.googlecode.com%2F%20--%3E%0A%0A%20%3Cg%20display%3D%22inline%22%3E%0A%20%20%20%20%3Cpath%20fill%3D%22%23000%22%20fill-rule%3D%22evenodd%22%20stroke%3D%22%23000%22%20stroke-width%3D%226%22%20d%3D%22m158.5%2C150l42%2C-130c0%2C0%2049%2C131%2049%2C131c0%2C0%20135%2C3%20135%2C3c0%2C0%20-109%2C80%20-109%2C80c0%2C0%2041%2C132%2041%2C132c0%2C0%20-93%2C-64%20-93%2C-64c0%2C0%200%2C-73%20-2%2C-74c-2%2C-1%20-32%2C-7%20-34%2C-5c-2%2C2%20-2%2C79%20-2%2C79c0%2C0%20-96%2C66%20-96%2C66c0%2C0%2040%2C-131%2040%2C-131c0%2C0%20-110%2C-86%20-110%2C-86c0%2C0%20139%2C-1%20139%2C-1%0A%0AM179.0278%2C185c0%2C-14.07304%2011.39915%2C-25.4722%2025.4722%2C-25.4722c14.07304%2C0%2025.4722%2C11.39915%2025.4722%2C25.4722c0%2C14.07304%20-11.39915%2C25.4722%20-25.4722%2C25.4722c-14.07304%2C0%20-25.4722%2C-11.39915%20-25.4722%2C-25.4722%22%2F%3E%0A%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E" width="48px"></a>
</li>
<li class="header-item header-site-home">
<a class="header-nav-link" href="./index.html">Didaxy</a>
</li>
<div id="header-toggle">üçî</div>
</ul>
<ul class="header-nav header-nav-right">


<li class="header-item header-collapsable dropdown">
<a class="tc-tiddlylink tc-tiddlylink-resolves header-nav-link" href="./recent.html">Recent</a>
</li>



<li class="header-item header-collapsable ">
<a class="tc-tiddlylink tc-tiddlylink-resolves header-nav-link" href="./tutorials.html">Tutorials</a>
</li>



<li class="header-item header-collapsable ">
<a class="tc-tiddlylink tc-tiddlylink-resolves header-nav-link" href="./contact.html">Contact</a>
</li>


</ul>
</nav></p><section class="page-content">
<p><div class="frame"><div class="tc-tiddler-body tc-reveal"><h2 class="">mLab</h2><p>Now we make an mLab database - a new "deployment" - we want a single-node, sandbox type database which is free and gives us 0.5gb of space, which should be way more than we use.</p><p>You'll then need to add a user for this database and give them a password (you should see warnings telling you to do this)</p><p>You should see example connection strings like this </p><pre><code> mongo ds143717.mlab.com:43717/authbase -u &lt;dbuser&gt; -p &lt;dbpassword&gt; </code></pre><p>and this</p><pre><code>mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@ds143717.mlab.com:43717/authbase</code></pre><p>Take note of these (they will be different for your database) and remember the username and password that you've given to your database user.</p><p>Now we'll change authbase.js so that it connects to our database.</p><p>Richards-MacBook-Air:authbase richardsmith$ npm install mongodb ‚Äìsave</p><pre><code>TEST="this is a secret file!"
MONGO_CONNECT_STRING="mongodb://admin:122eoh@ds143717.mlab.com:43717/authbase"</code></pre><p>wrap our app.listen command in a connection to the database</p><pre><code>MongoClie       t.connect(mongoUrl, (err, database) =&gt; {
  if (err) return console.log(err)
  db = database
  app.listen(process.env.PORT || 3000, () =&gt; {
    console.log('listening on 3000 (with mongo connection)')
  })})</code></pre><p>then change our index.ejs file so that it lets us get things out of the database and put things into it</p><pre><code>&lt;h2&gt;Add Something to the Database&lt;/h2&gt;
  &lt;form action ="/sumbit_database_item" method="POST"&gt;
  &lt;input type="text" name="db_item" placeholder="add something!"&gt;&lt;/input&gt;
  &lt;button type="submit"&gt;Submit&lt;/button&gt;
  &lt;/form&gt;

  &lt;div class = "recent"&gt;
    &lt;h2&gt;Recently&lt;/h2&gt;
    &lt;ul&gt;
    &lt;% for(var i=0; i&lt;docs.length; i++) {%&gt;
       &lt;li&gt;&lt;a href="&lt;%= docs[i].short_url%&gt;" target="blank"&gt;(&lt;%= host%&gt;/&lt;%= docs[i].short_url%&gt;)&lt;/a&gt; &lt;%= docs[i].long_url%&gt; (&lt;%= docs[i].ipaddress%&gt;)&lt;/li&gt;
    &lt;% } %&gt;
    &lt;/ul&gt;
  &lt;/div&gt;</code></pre><p>this is the ejs syntax for iterating over the elements of an array. We want to populate this array <code>docs</code> with the search results from our database. In this case, we're just pulling out the last ten things that were put in.</p><pre><code>app.get('/', (req, res) =&gt; {
  db.collection(col).find({}).sort({_id:-1}).limit(10).toArray(function(err, docs){
    console.log("retrieved records:");
    console.log(docs);
    res.render('index.ejs', {docs, host: req.headers.host, envtest: process.env.TEST})
  })
})</code></pre><p>The submission form gives us a very simple way to add things.</p><p>This is just an HTML form - when we click submit, it will try to POST it's results to the specified URL - /sumbit_database_item - so we need to tell our express app how to deal with the submission.</p><p>authbase.js at this point looks like this;</p><pre><code>//authbase.js
require('dotenv').config()

const MongoClient = require('mongodb').MongoClient;
const mongoUrl = process.env.MONGO_CONNECT_STRING
const col = "testItems"; //the name of the mongo collection to use - change for production


const express = require('express');
const app = express();
const bodyParser = require('body-parser');


//view engine
app.set('view engine', 'ejs');

//middleware
app.use(bodyParser.urlencoded({extended: true}))

MongoClient.connect(mongoUrl, (err, database) =&gt; {
  if (err) return console.log(err)
  db = database
  app.listen(process.env.PORT || 3000, () =&gt; {
    console.log('listening on 3000 (with mongo connection)')
  })})

app.get('/', (req, res) =&gt; {
  db.collection(col).find({}).sort({_id:-1}).limit(10).toArray(function(err, docs){
    console.log("retrieved records:");
    console.log(docs);
    res.render('index.ejs', {docs, host: req.headers.host, envtest: process.env.TEST})
  })
})

app.post('/sumbit_database_item', (req,res) =&gt; {
  db.collection(col).insertOne({name:req.body.db_item}, (err, result) =&gt; {
    if (err) return res.send(500, err)
    res.redirect('/')
  })
})</code></pre><p>and index.ejs looks like this</p><pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Node app on Heroku with Mongo Backend and Twitter-auth&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;h1&gt;Authentication Demonstration&lt;/h2&gt;
  &lt;p&gt;This will be a Heroku app backed by mongoDB on mLab, with Twitter authentication.&lt;/p&gt;
  &lt;p&gt;The url of this page is &lt;span&gt;&lt;%= host %&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;p&gt;dotEnv says: &lt;%= envtest %&gt;&lt;/p&gt;
  &lt;h2&gt;Add Something to the Database&lt;/h2&gt;
  &lt;form action ="/sumbit_database_item" method="POST"&gt;
  &lt;input type="text" name="db_item" placeholder="add something!"&gt;&lt;/input&gt;
  &lt;button type="submit"&gt;Submit&lt;/button&gt;
  &lt;/form&gt;

  &lt;div class = "recent"&gt;
    &lt;h2&gt;Recently&lt;/h2&gt;
    &lt;ul&gt;
    &lt;% for(var i=0; i&lt;docs.length; i++) {%&gt;
       &lt;li&gt;&lt;%= docs[i].name%&gt;&lt;/li&gt;
    &lt;% } %&gt;
    &lt;/ul&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;h3&gt;Credits&lt;/h3&gt;
    &lt;p&gt;Made with love by &lt;a href="www.r1chard5mith.com" title="link to my personal home page"&gt;Richard Smith&lt;/a&gt; as part of &lt;a href="https://www.freecodecamp.com" title="link to free code camp home page"&gt;Free Code Camp&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;See the code on &lt;a href="https://github.com/r1chard5mith/authbase"&gt;Github&lt;/a&gt;.&lt;/p&gt;
&lt;/body&gt;

&lt;/html&gt;</code></pre><p>Explain how this all works and how to test it.</p><pre><code>  544  git push heroku master
  545  heroku open
  546  heroku config:set MONGO_CONNECT_STRING="mongodb://admin:122eoh@ds143717.mlab.com:43717/authbase"
  547  heroku open
  548  history</code></pre><p>Push the changes to Github.
Deploy it to heroku... (don't forget to set the environment variable)</p><p>And we're able to insert things into our mLab database, which we can see if we visit the web console on mLab - you may need to refresh the page to see the changes. You should see the entries that you made.</p><p>So, we're all good to go?</p><p>Kinda.</p><p>Now that we have our project set up on github and it's a breeze to push it to 'production' on Heroku, we want to get into the meat of making it do what we want it to do.</p><p>Unfortunately, we're going to see that if we want to make even a small change to our app, nodemon is going to restart the process and it's going to need to reconnect to mLab before we can test our changes.</p><p>Let's see it - change the line </p><p>console.log('listening on 3000 (with mongo connection)')</p><p>console.log('listening on 3000 (with super mongo connection)')</p><p>It takes about 2 seconds for me to get a reconnection. That sort of delay isn't any barrier to people succssfully using your service, but it's going to get really tiring to debug if it takes 2 seconds every time we have to test something.</p><p>This is why we need a local Mongo set-up for testing.</p><p>That's going to be the second tutorial - how to set up a local mongo installation, point our existing app at it, add functionality with a quicker update loop and then point our app back at our 'production' database when we're ready for it to go live again.</p><p><a class="tc-tiddlylink tc-tiddlylink-missing" href="./installing-mongo-locally.html">Installing Mongo Locally</a></p><p>We've got an app connecting to an online mongo database, somewhere up in the cloud, but we want our own <em>local</em> Mongo to do testing with.</p><p>No problem.</p><p>It's not at all difficult, but if you've not used the terminal very much before, it might seem a bit daunting. We're going to end up with a bunch of different terminal windows open, with different things running in them.</p><p>The first one is going to have mongo itself in it </p><p>Let's just install it, using these instructions - </p><hr><p>We successfully avoided having to use Homebrew in our previous tutorial, but it looks as though we won't be so lucky with mongo db community edition.</p><p><a class="tc-tiddlylink-external" href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/" rel="noopener noreferrer" target="_blank">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/</a></p><p>Installing it requires homebrew and homebrew requires the xcode developer tools (if you're following along, you already have those installed)</p><p>Let's install homebrew by pasting these magic words into the terminal as we're told to do.</p><pre><code>/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</code></pre><p>now we can</p><pre><code>brew install mongodb</code></pre><p>You need to do mkdir -p /data/db</p><p>and then you need to give yourself permissions to edit this.</p><p>I find the whole idea of multiple permissions a bit weird on my one player laptop so I'm quite content to do a <code>sudo chmod 777 /data/*</code> and get it over with, then we can do <code>mongod</code> and the daemon runs.</p><p>when we run it with the mongod (it's the mongo daemon - a process that runs in the background to manage resources for us, in this case, the database.</p><p>Now we have our own database running. It's that simple. But we have no way to interact with it.</p><p>The first way to do this is using the mongo shell.</p><p>Open a new terminal window and this time just type 'mongo' (for windows it's mongo.exe, the instructions are here: <a class="tc-tiddlylink-external" href="https://docs.mongodb.com/getting-started/shell/client/" rel="noopener noreferrer" target="_blank">https://docs.mongodb.com/getting-started/shell/client/</a></p><p>The docs for the shell are here</p><p><a class="tc-tiddlylink-external" href="https://docs.mongodb.com/manual/reference/mongo-shell/" rel="noopener noreferrer" target="_blank">https://docs.mongodb.com/manual/reference/mongo-shell/</a></p><p>You can use it to find out about your new database.</p><hr><p>In a moment we are going to connect our node app to this database and manipulate it with that, but first we can install another node app called adminMongo.</p><p>admin Mongo is available here <a class="tc-tiddlylink-external" href="https://github.com/mrvautin/adminMongo" rel="noopener noreferrer" target="_blank">https://github.com/mrvautin/adminMongo</a></p><p>You just need to get a copy of it and install it the same way you install your own node apps - if you're using github desktop, it's very easy to get repos.</p><p>Now, in  another terminal window, find the directory you cloned it to and <code>npm install</code> it and then do <code>npm start</code> (see the docs at the above link)</p><p>Now, in your browser, you can visit localhost:1234 and you get an admin console on your local database, just like the one we got to our 'production' database.</p><p>Assuming you followed all the defaults when installing mongo, you can give adminMongo the connection url <code>mongodb://localhost:27017</code> and a suitable name, then click connect.</p><p>The only thing that's missing now is our app itself.</p><p>In a fourth terminal window, now, we want to run our app with nodemon</p><p>Of course our app is still configured to point to our online database, so before we start it, we need to change that.</p><p>Let's rename our production .env file to production.env and change our .env file to look like this</p><pre><code>TEST="this is a secret file!"
MONGO_CONNECT_STRING="mongodb://localhost:27017"</code></pre><p>and start our app using nodemon.js</p><p>now it's pointing at our local db and magic starts to happen.</p></div>
</div>
</p>

</section><p><footer class="footer">
<div><div class="content-footer-navigation"><p><a class="tc-tiddlylink tc-tiddlylink-resolves" href="./about.html">About</a> | <a class="tc-tiddlylink tc-tiddlylink-resolves" href="./tutorials.html">Tutorials</a> | <a class="tc-tiddlylink tc-tiddlylink-resolves" href="./contact.html">Contact</a>
</p></div><p><a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" style="border-width:0"></a></p></div><div>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">Creative Commons Attribution 4.0 International License</a>.</div>
<div>Made with Love in Melbourne, Australia</div>

</footer>
</p>


</body>
</html>
